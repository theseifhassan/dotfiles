#!/bin/sh
set -e

DOTFILES="${DOTFILES:-$HOME/dotfiles}"

log() { echo ">>> $1"; }

cmd_update() {
    cd "$DOTFILES"
    [ "$1" != "--no-pull" ] && {
        git diff-index --quiet HEAD -- 2>/dev/null || { echo "Uncommitted changes. Continue? [y/N]"; read -r a; [ "$a" != "y" ] && exit 1; }
        log "Pulling..."; git pull --rebase
    }
    log "Suckless..."
    for d in dwm dmenu dwmblocks; do [ -d "$DOTFILES/$d" ] && { make -C "$DOTFILES/$d" clean >/dev/null 2>&1 || true; sudo make -C "$DOTFILES/$d" install >/dev/null; }; done
    pgrep -x dwm >/dev/null && pkill -HUP dwm
    pgrep -x dwmblocks >/dev/null && { killall dwmblocks; dwmblocks & }
    [ -n "$DISPLAY" ] && xrdb -I"$HOME/.local/share" -merge "$HOME/.config/x11/xresources" 2>/dev/null || true
    log "Done!"
}

cmd_link() {
    log "Linking..."
    link() { mkdir -p "$(dirname "$2")"; [ -L "$2" ] && rm "$2"; [ -e "$2" ] && mv "$2" "$2.bak"; ln -s "$1" "$2"; }

    # Copy defaults to XDG_DATA_HOME (decouples runtime from repo)
    log "Copying defaults..."
    rm -rf "${XDG_DATA_HOME:-$HOME/.local/share}/dotfiles"
    cp -r "$DOTFILES/default" "${XDG_DATA_HOME:-$HOME/.local/share}/dotfiles"

    # Install fonts if present
    if [ -d "$DOTFILES/fonts" ] && [ "$(ls -A "$DOTFILES/fonts" 2>/dev/null | grep -v .keep)" ]; then
        log "Installing fonts..."
        mkdir -p "${XDG_DATA_HOME:-$HOME/.local/share}/fonts"
        cp -r "$DOTFILES/fonts/"* "${XDG_DATA_HOME:-$HOME/.local/share}/fonts/" 2>/dev/null || true
        fc-cache -f
    fi

    # Install TPM if not present
    TPM_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/tmux/plugins/tpm"
    if [ ! -d "$TPM_DIR" ]; then
        log "Installing TPM..."
        git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
    fi

    link "$DOTFILES/zsh/.zshenv" "$HOME/.zshenv"
    link "$DOTFILES/zsh/.config/zsh" "$HOME/.config/zsh"
    link "$DOTFILES/x11/.config/x11" "$HOME/.config/x11"
    link "$DOTFILES/nvim/.config/nvim" "$HOME/.config/nvim"
    link "$DOTFILES/tmux/.config/tmux" "$HOME/.config/tmux"
    link "$DOTFILES/ghostty/.config/ghostty" "$HOME/.config/ghostty"
    link "$DOTFILES/picom/.config/picom" "$HOME/.config/picom"
    link "$DOTFILES/dunst/.config/dunst" "$HOME/.config/dunst"
    link "$DOTFILES/git/.config/git" "$HOME/.config/git"
    link "$DOTFILES/ripgrep/.config/ripgrep" "$HOME/.config/ripgrep"
    link "$DOTFILES/starship/.config/starship.toml" "$HOME/.config/starship.toml"
    link "$DOTFILES/opencode/.config/opencode" "$HOME/.config/opencode"
    link "$DOTFILES/autorandr/.config/autorandr" "$HOME/.config/autorandr"
    link "$DOTFILES/fontconfig/.config/fontconfig" "$HOME/.config/fontconfig"
    link "$DOTFILES/npm/.config/npm" "$HOME/.config/npm"

    # Link wallpapers if present
    if [ -d "$DOTFILES/wallpapers" ] && [ "$(ls -A "$DOTFILES/wallpapers" 2>/dev/null | grep -v .keep)" ]; then
        mkdir -p "$HOME/Pictures"
        link "$DOTFILES/wallpapers" "$HOME/Pictures/Wallpapers"
    fi


    mkdir -p "$HOME/.local/bin"
    for f in "$DOTFILES/scripts/.local/bin/"*; do link "$f" "$HOME/.local/bin/$(basename "$f")"; done

    # Link web apps
    mkdir -p "$HOME/.local/share/applications"
    for f in "$DOTFILES/applications/.local/share/applications/"*.desktop; do
        [ -f "$f" ] && link "$f" "$HOME/.local/share/applications/$(basename "$f")"
    done

    mkdir -p "$HOME/.config/systemd/user"
    for f in "$DOTFILES/scripts/.config/systemd/user/"*; do link "$f" "$HOME/.config/systemd/user/$(basename "$f")"; done

    systemctl --user daemon-reload
    log "Done!"
}

cmd_packages() {
    PKGFILE="$DOTFILES/install/packages"
    [ ! -f "$PKGFILE" ] && { echo "install/packages not found"; exit 1; }
    [ "$1" = "-d" ] || [ "$1" = "--diff" ] && {
        log "Missing:"
        while IFS= read -r p || [ -n "$p" ]; do case "$p" in \#*|"") continue;; esac; pacman -Qi "$p" >/dev/null 2>&1 || echo "  $p"; done < "$PKGFILE"
        exit 0
    }
    log "Installing..."
    yay -S --needed --noconfirm $(grep -vE "^\s*#|^\s*$" "$PKGFILE" | tr '\n' ' ')
}

cmd_suckless() {
    t="${1:-all}"; log "Building $t..."
    if [ "$t" = "all" ]; then for d in dwm dmenu dwmblocks; do [ -d "$DOTFILES/$d" ] && sudo make -C "$DOTFILES/$d" clean install; done
    else [ -d "$DOTFILES/$t" ] && sudo make -C "$DOTFILES/$t" clean install; fi
    pgrep -x dwm >/dev/null && pkill -HUP dwm
    pgrep -x dwmblocks >/dev/null && { killall dwmblocks; dwmblocks & }
}

cmd_hardware() { "$DOTFILES/install/hardware.sh" "$@"; }
cmd_install() { "$DOTFILES/install/setup.sh"; }

cmd_monitor() {
    case "${1:-}" in
        save)
            [ -z "${2:-}" ] && { echo "Usage: dot monitor save <name>"; exit 1; }
            autorandr --save "$2"
            echo "Profile '$2' saved. Use 'dot monitor switch $2' to load it."
            ;;
        switch|load)
            [ -z "${2:-}" ] && { echo "Usage: dot monitor switch <name>"; exit 1; }
            autorandr --load "$2" --force
            ;;
        list)
            autorandr
            ;;
        *)
            cat <<EOF
dot monitor <cmd>
  save <name>    Save current display config as profile
  switch <name>  Switch to a saved profile
  list           List available profiles

Setup guide:
  1. With laptop screen only:  dot monitor save laptop
  2. With external monitor:    dot monitor save docked
  Profiles auto-switch when displays connect/disconnect.
EOF
            ;;
    esac
}

cmd_help() { cat <<EOF
dot <cmd> [args]
  update [--no-pull]  Pull, recompile, reload
  link                Symlink configs
  packages [-d]       Install packages (-d: show missing)
  suckless [target]   Recompile dwm/dmenu/dwmblocks
  hardware <cmd>      Install: nvidia|bluetooth|printer|fingerprint|virtualcam|all
                      Verify:  check [device]
  monitor <cmd>       Manage display profiles (save|switch|list)
  install             Full setup
EOF
}

case "${1:-}" in
    update) shift; cmd_update "$@" ;;
    link) cmd_link ;;
    packages) shift; cmd_packages "$@" ;;
    suckless) shift; cmd_suckless "$@" ;;
    hardware) shift; cmd_hardware "$@" ;;
    monitor) shift; cmd_monitor "$@" ;;
    install) cmd_install ;;
    *) cmd_help ;;
esac
