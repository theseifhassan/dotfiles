#!/bin/sh
set -e

DOTFILES="${DOTFILES:-$HOME/dotfiles}"

log() { echo ">>> $1"; }

cmd_update() {
    cd "$DOTFILES"
    [ "$1" != "--no-pull" ] && {
        git diff-index --quiet HEAD -- 2>/dev/null || { echo "Uncommitted changes. Continue? [y/N]"; read -r a; [ "$a" != "y" ] && exit 1; }
        log "Pulling..."; git pull --rebase
    }
    log "Suckless..."
    for d in dwm dmenu dwmblocks; do [ -d "$DOTFILES/$d" ] && { make -C "$DOTFILES/$d" clean >/dev/null 2>&1 || true; sudo make -C "$DOTFILES/$d" install >/dev/null; }; done
    pgrep -x dwm >/dev/null && pkill -HUP dwm
    pgrep -x dwmblocks >/dev/null && { killall dwmblocks; dwmblocks & }
    [ -n "$DISPLAY" ] && xrdb -I"$HOME/.local/share" -merge "$HOME/.config/x11/xresources" 2>/dev/null || true
    log "Done!"
}

cmd_link() {
    log "Linking..."
    link() { mkdir -p "$(dirname "$2")"; [ -L "$2" ] && rm "$2"; [ -e "$2" ] && mv "$2" "$2.bak"; ln -s "$1" "$2"; }

    # Copy defaults to XDG_DATA_HOME (decouples runtime from repo)
    log "Copying defaults..."
    target="${XDG_DATA_HOME:-$HOME/.local/share}/dotfiles"
    case "$target" in */dotfiles) ;; *) echo "Safety check failed: $target"; exit 1 ;; esac
    rm -rf "$target"
    cp -r "$DOTFILES/default" "$target"

    # Clone private fonts repo if not present
    if [ ! -d "$DOTFILES/fonts/.git" ]; then
        log "Cloning private fonts..."
        rm -rf "$DOTFILES/fonts"
        git clone git@github.com:theseifhassan/fonts.git "$DOTFILES/fonts" 2>/dev/null || {
            log "Could not clone fonts (private repo - need SSH key)"
            mkdir -p "$DOTFILES/fonts"
        }
    fi

    # Install fonts if present
    if [ -d "$DOTFILES/fonts" ] && [ "$(ls -A "$DOTFILES/fonts" 2>/dev/null | grep -v .keep | grep -v .git)" ]; then
        log "Installing fonts..."
        mkdir -p "${XDG_DATA_HOME:-$HOME/.local/share}/fonts"
        find "$DOTFILES/fonts" -maxdepth 1 -type f \( -name "*.ttf" -o -name "*.otf" \) -exec cp {} "${XDG_DATA_HOME:-$HOME/.local/share}/fonts/" \;
        fc-cache -f
    fi

    # Install TPM if not present
    TPM_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/tmux/plugins/tpm"
    if [ ! -d "$TPM_DIR" ]; then
        log "Installing TPM..."
        git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
    fi

    link "$DOTFILES/zsh/.zshenv" "$HOME/.zshenv"
    link "$DOTFILES/zsh/.config/zsh" "$HOME/.config/zsh"
    link "$DOTFILES/x11/.config/x11" "$HOME/.config/x11"
    link "$DOTFILES/nvim/.config/nvim" "$HOME/.config/nvim"
    link "$DOTFILES/tmux/.config/tmux" "$HOME/.config/tmux"
    link "$DOTFILES/ghostty/.config/ghostty" "$HOME/.config/ghostty"
    link "$DOTFILES/picom/.config/picom" "$HOME/.config/picom"
    link "$DOTFILES/dunst/.config/dunst" "$HOME/.config/dunst"
    link "$DOTFILES/git/.config/git" "$HOME/.config/git"
    link "$DOTFILES/ripgrep/.config/ripgrep" "$HOME/.config/ripgrep"
    link "$DOTFILES/starship/.config/starship.toml" "$HOME/.config/starship.toml"
    link "$DOTFILES/opencode/.config/opencode" "$HOME/.config/opencode"
    link "$DOTFILES/autorandr/.config/autorandr" "$HOME/.config/autorandr"
    link "$DOTFILES/fontconfig/.config/fontconfig" "$HOME/.config/fontconfig"
    link "$DOTFILES/npm/.config/npm" "$HOME/.config/npm"
    link "$DOTFILES/mise/.config/mise" "$HOME/.config/mise"
    link "$DOTFILES/ssh/.ssh/config" "$HOME/.ssh/config"
    link "$DOTFILES/1password/.config/1Password/ssh/agent.toml" "$HOME/.config/1Password/ssh/agent.toml"

    # Link wallpapers if present
    if [ -d "$DOTFILES/wallpapers" ] && [ "$(ls -A "$DOTFILES/wallpapers" 2>/dev/null | grep -v .keep)" ]; then
        mkdir -p "$HOME/Pictures"
        link "$DOTFILES/wallpapers" "$HOME/Pictures/Wallpapers"
    fi


    mkdir -p "$HOME/.local/bin"
    for f in "$DOTFILES/scripts/.local/bin/"*; do link "$f" "$HOME/.local/bin/$(basename "$f")"; done

    # Link web apps
    mkdir -p "$HOME/.local/share/applications"
    for f in "$DOTFILES/applications/.local/share/applications/"*.desktop; do
        [ -f "$f" ] && link "$f" "$HOME/.local/share/applications/$(basename "$f")"
    done

    mkdir -p "$HOME/.config/systemd/user"
    for f in "$DOTFILES/scripts/.config/systemd/user/"*; do link "$f" "$HOME/.config/systemd/user/$(basename "$f")"; done

    systemctl --user daemon-reload
    log "Done!"
}

cmd_packages() {
    PKGFILE="$DOTFILES/install/packages"
    [ ! -f "$PKGFILE" ] && { echo "install/packages not found"; exit 1; }
    [ "$1" = "-d" ] || [ "$1" = "--diff" ] && {
        log "Missing:"
        while IFS= read -r p || [ -n "$p" ]; do case "$p" in \#*|"") continue;; esac; pacman -Qi "$p" >/dev/null 2>&1 || echo "  $p"; done < "$PKGFILE"
        exit 0
    }
    log "Installing..."
    grep -vE "^\s*#|^\s*$" "$PKGFILE" | xargs yay -S --needed --noconfirm
}

cmd_suckless() {
    t="${1:-all}"; log "Building $t..."
    if [ "$t" = "all" ]; then for d in dwm dmenu dwmblocks; do [ -d "$DOTFILES/$d" ] && sudo make -C "$DOTFILES/$d" clean install; done
    else [ -d "$DOTFILES/$t" ] && sudo make -C "$DOTFILES/$t" clean install; fi
    pgrep -x dwm >/dev/null && pkill -HUP dwm
    pgrep -x dwmblocks >/dev/null && { killall dwmblocks; dwmblocks & }
}

cmd_hardware() { "$DOTFILES/install/hardware.sh" "$@"; }
cmd_install() { "$DOTFILES/install/setup.sh"; }

cmd_tools() {
    command -v mise >/dev/null 2>&1 || {
        log "Installing mise..."
        curl https://mise.run | sh
        export PATH="$HOME/.local/bin:$PATH"
    }

    case "${1:-}" in
        install|"")
            log "Installing tools via mise..."
            mise install
            ;;
        upgrade)
            log "Upgrading tools..."
            mise upgrade
            ;;
        list)
            mise list
            ;;
        outdated)
            mise outdated
            ;;
        *)
            cat <<EOF
dot tools <cmd>
  install     Install all tools from mise config (default)
  upgrade     Upgrade all tools to latest
  list        List installed tools
  outdated    Show outdated tools
EOF
            ;;
    esac
}

cmd_wallpaper() {
    WALLPAPER_DIR="${WALLPAPER_DIR:-$HOME/Pictures/Wallpapers}"
    STATE_FILE="${XDG_STATE_HOME:-$HOME/.local/state}/wallpaper_index"
    
    [ ! -d "$WALLPAPER_DIR" ] && { echo "Wallpaper dir not found: $WALLPAPER_DIR"; exit 1; }
    
    # Get sorted list of wallpapers
    wallpapers=$(find -L "$WALLPAPER_DIR" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" \) | sort)
    count=$(echo "$wallpapers" | grep -c . || echo 0)
    [ "$count" -eq 0 ] && { echo "No wallpapers found"; exit 1; }
    
    # Get current wallpaper from feh state
    current=""
    [ -f "$HOME/.fehbg" ] && current=$(sed -n "s/.*'\([^']*\)'[^']*$/\1/p" "$HOME/.fehbg" 2>/dev/null || true)

    # Find current index
    idx=0
    if [ -n "$current" ]; then
        i=0
        while IFS= read -r w; do
            [ "$w" = "$current" ] && { idx=$i; break; }
            i=$((i + 1))
        done <<EOF
$wallpapers
EOF
    fi
    
    set_wallpaper() {
        wp=$(echo "$wallpapers" | sed -n "$((${1} + 1))p")
        [ -n "$wp" ] && { feh --bg-fill "$wp"; echo "$1" > "$STATE_FILE"; echo "Set: $(basename "$wp")"; }
    }
    
    case "${1:-}" in
        next)
            new_idx=$(( (idx + 1) % count ))
            set_wallpaper "$new_idx"
            ;;
        prev)
            new_idx=$(( (idx - 1 + count) % count ))
            set_wallpaper "$new_idx"
            ;;
        random)
            new_idx=$(shuf -i 0-$((count - 1)) -n 1)
            set_wallpaper "$new_idx"
            ;;
        current|status)
            [ -n "$current" ] && echo "Current: $(basename "$current")" || echo "No wallpaper set"
            echo "Total: $count wallpapers"
            ;;
        list)
            echo "$wallpapers" | while IFS= read -r w; do
                [ "$w" = "$current" ] && echo "* $(basename "$w")" || echo "  $(basename "$w")"
            done
            ;;
        *)
            cat <<EOF
dot wallpaper <cmd>
  next      Next wallpaper in sequence
  prev      Previous wallpaper
  random    Random wallpaper
  current   Show current wallpaper
  list      List all wallpapers (* = current)
EOF
            ;;
    esac
}

cmd_monitor() {
    case "${1:-}" in
        save)
            [ -z "${2:-}" ] && { echo "Usage: dot monitor save <name>"; exit 1; }
            autorandr --save "$2"
            echo "Profile '$2' saved. Use 'dot monitor switch $2' to load it."
            ;;
        switch|load)
            [ -z "${2:-}" ] && { echo "Usage: dot monitor switch <name>"; exit 1; }
            autorandr --load "$2" --force
            ;;
        list)
            autorandr
            ;;
        *)
            cat <<EOF
dot monitor <cmd>
  save <name>    Save current display config as profile
  switch <name>  Switch to a saved profile
  list           List available profiles

Setup guide:
  1. With laptop screen only:  dot monitor save laptop
  2. With external monitor:    dot monitor save docked
  Profiles auto-switch when displays connect/disconnect.
EOF
            ;;
    esac
}

cmd_help() { cat <<EOF
dot <cmd> [args]
  update [--no-pull]  Pull, recompile, reload
  link                Symlink configs
  packages [-d]       Install packages (-d: show missing)
  tools <cmd>         Manage dev tools via mise (install|upgrade|list|outdated)
  suckless [target]   Recompile dwm/dmenu/dwmblocks
  hardware <cmd>      Install: nvidia|bluetooth|printer|fingerprint|virtualcam|all
                      nvidia disable - Disable GPU for max battery
                      Verify: check [device]
  monitor <cmd>       Manage display profiles (save|switch|list)
  wallpaper <cmd>     Cycle wallpapers (next|prev|random|current|list)
  install             Full setup
EOF
}

case "${1:-}" in
    update) shift; cmd_update "$@" ;;
    link) cmd_link ;;
    packages) shift; cmd_packages "$@" ;;
    tools) shift; cmd_tools "$@" ;;
    suckless) shift; cmd_suckless "$@" ;;
    hardware) shift; cmd_hardware "$@" ;;
    monitor) shift; cmd_monitor "$@" ;;
    wallpaper|wp) shift; cmd_wallpaper "$@" ;;
    install) cmd_install ;;
    *) cmd_help ;;
esac
