#!/bin/sh
# Fetch SSH keys from 1Password and save to ~/.ssh/
# Reads key definitions from agent.toml (item + vault pairs)
set -e

# Ensure op is available and signed in
command -v op >/dev/null 2>&1 || { echo "1password-cli (op) not installed"; exit 1; }
op account list >/dev/null 2>&1 || { echo "Sign in first: eval \$(op signin)"; exit 1; }

# Load keys defined in agent.toml
AGENT_TOML="${XDG_CONFIG_HOME:-$HOME/.config}/1Password/ssh/agent.toml"
if [ ! -f "$AGENT_TOML" ]; then
    echo "No agent.toml found at $AGENT_TOML"
    exit 1
fi

mkdir -p "$HOME/.ssh" && chmod 700 "$HOME/.ssh"

# Pass 1: collect all entries (item|vault|base) from agent.toml
tmpfile=$(mktemp)
trap 'rm -f "$tmpfile"' EXIT

item="" vault=""
flush_entry() {
    [ -z "$item" ] || [ -z "$vault" ] && return 0
    base=$(printf '%s' "$item" | tr '[:upper:]' '[:lower:]' | sed 's/ ssh key$//;s/ /-/g')
    printf '%s|%s|%s\n' "$item" "$vault" "$base" >> "$tmpfile"
    item="" vault=""
}

while IFS= read -r line; do
    case "$line" in
        '[[ssh-keys]]'*) flush_entry ;;
        *'item = "'*) item=$(echo "$line" | sed 's/.*item = "\([^"]*\)".*/\1/') ;;
        *'vault = "'*) vault=$(echo "$line" | sed 's/.*vault = "\([^"]*\)".*/\1/') ;;
    esac
done < "$AGENT_TOML"
flush_entry

# Pass 2: fetch keys, disambiguating duplicate base names with vault prefix
while IFS='|' read -r item vault base; do
    [ -z "$item" ] && continue
    count=$(cut -d'|' -f3 "$tmpfile" | grep -cx "$base")
    if [ "$count" -gt 1 ]; then
        name="$(printf '%s' "$vault" | tr '[:upper:]' '[:lower:]').${base}"
    else
        name="$base"
    fi

    echo "Fetching: $item ($vault) -> ~/.ssh/$name"

    op read "op://$vault/$item/public key" > "$HOME/.ssh/${name}.pub"
    chmod 644 "$HOME/.ssh/${name}.pub"

    op read "op://$vault/$item/private key?ssh-format=openssh" | tr -d '\r' > "$HOME/.ssh/${name}"
    printf '\n' >> "$HOME/.ssh/${name}"
    chmod 600 "$HOME/.ssh/${name}"
done < "$tmpfile"

echo "SSH keys saved to ~/.ssh/"
