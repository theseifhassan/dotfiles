#!/bin/sh
# Fetch SSH keys from 1Password and save to ~/.ssh/
# Reads key definitions from agent.toml (item + vault pairs)
set -e

# Ensure op is available and signed in
command -v op >/dev/null 2>&1 || { echo "1password-cli (op) not installed"; exit 1; }
op account list >/dev/null 2>&1 || { echo "Sign in first: eval \$(op signin)"; exit 1; }

# Load keys defined in agent.toml
AGENT_TOML="${XDG_CONFIG_HOME:-$HOME/.config}/1Password/ssh/agent.toml"
if [ ! -f "$AGENT_TOML" ]; then
    echo "No agent.toml found at $AGENT_TOML"
    exit 1
fi

mkdir -p "$HOME/.ssh" && chmod 700 "$HOME/.ssh"

# Parse item names and vaults from agent.toml
while IFS= read -r line; do
    case "$line" in
        *'item = "'*)
            item=$(echo "$line" | sed 's/.*item = "\([^"]*\)".*/\1/')
            ;;
        *'vault = "'*)
            vault=$(echo "$line" | sed 's/.*vault = "\([^"]*\)".*/\1/')
            # We now have both item and vault — fetch the keys
            prefix=$(echo "$vault" | tr '[:upper:]' '[:lower:]')
            echo "Fetching: $item ($vault) → ~/.ssh/${prefix}.github"

            # Public key
            pubkey_file="$HOME/.ssh/${prefix}.github.pub"
            op read "op://$vault/$item/public key" > "$pubkey_file"
            chmod 644 "$pubkey_file"

            # Private key
            privkey_file="$HOME/.ssh/${prefix}.github"
            op read "op://$vault/$item/private key?ssh-format=openssh" | tr -d '\r' > "$privkey_file"
            printf '\n' >> "$privkey_file"
            chmod 600 "$privkey_file"
            ;;
    esac
done < "$AGENT_TOML"

echo "SSH keys saved to ~/.ssh/"
