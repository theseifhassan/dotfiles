#!/bin/sh
# autorandr postswitch hook - adjusts DPI based on profile
# Runs after autorandr switches display profiles

case "$AUTORANDR_CURRENT_PROFILE" in
    docked|external|hidpi)
        DPI=192
        DOCKED=1
        ;;
    *)
        DPI=96
        DOCKED=0
        ;;
esac

# Update Xft.dpi via xrdb
echo "Xft.dpi: $DPI" | xrdb -merge

# Restart dwm to pick up new DPI (uses restartsig patch)
pgrep -x dwm >/dev/null && pkill -HUP dwm

# Restart dwmblocks (always ensure it's running)
killall dwmblocks 2>/dev/null; dwmblocks &

# Power management: disable lid/idle sleep when docked
# Done last because HUP to logind can affect user processes
if [ "$DOCKED" = "1" ]; then
    sudo mkdir -p /etc/systemd/logind.conf.d
    sudo tee /etc/systemd/logind.conf.d/docked.conf >/dev/null << 'EOF'
[Login]
HandleLidSwitch=ignore
HandleLidSwitchExternalPower=ignore
HandleLidSwitchDocked=ignore
IdleAction=ignore
EOF
else
    sudo rm -f /etc/systemd/logind.conf.d/docked.conf
fi
# Use loginctl reload - gentler than HUP signal
sudo loginctl reload

# Restart dunst (reads Xft.dpi on startup)
pgrep -x dunst >/dev/null && { killall dunst 2>/dev/null; dunst & }

# Restart ghostty (doesn't respond to DPI changes)
pgrep -x ghostty >/dev/null && { killall ghostty 2>/dev/null; ghostty & }

# Restart chromium (doesn't respond to DPI changes)
# Uses --restore-last-session to recover tabs
if pgrep -x chromium >/dev/null; then
    killall chromium 2>/dev/null
    sleep 0.5
    chromium --restore-last-session &
fi

# Restore wallpaper for new resolution
[ -f ~/.fehbg ] && . ~/.fehbg &

# Notify user
command -v notify-send >/dev/null && notify-send -i display "Display" "$AUTORANDR_CURRENT_PROFILE (DPI: $DPI)"
